sample.asm13 FNAME "sample.bin"5 6fm1_reg: equ $c47fm1_data: equ $c58fm2_reg: equ $c69fm2_data: equ $c710pcm_reg: equ $7e11pcm_data: equ $7f14 15 db $FE16 dw start, end, start17 18 org $800019 20start: call convert 22 ld a,523 out (fm2_reg),a24 ld a,325 out (fm2_data),a 27 ld e,$2028 ld hl,$060029 call set_opl4_wrt 30 31 ld hl,sample32 ld de,end - sample33 call ramtosram 34 35 ld e,$2036 ld hl,0 37 call set_opl4_wrt 38 39 ld hl,tonedata40 ld de,1241 call ramtosram 42 43 ld c,244 ld a,%1000045 call opl4_out_wave 46 47 ld c,$2048 ld a,%00000001 49 call opl4_out_wave50 51 ld c,$0852 ld a,%10000000 53 call opl4_out_wave54 55 ld c,$3856 ld a,%11110000 57 call opl4_out_wave58 59 ld c,$5060 ld a,0 61 call opl4_out_wave62 63 ld c,$6864 ld a,0 65 call opl4_out_wave66 67 ld c,$6868 ld a,%10000000 69 call opl4_out_wave70 71 ret72 73 74tonedata: db $20,$06,$00 75 db (end-sample)>>8, (end-sample) and 255 76 db not((end-sample)>>8), not((end-sample) and 255) 77 db 0 78 db %11110000 79 db %00000000 80 db %00001111 81 db %00000000 82 83 8490opl4_out_wave:91 ex af,af'92 ld a,c93 out (pcm_reg),a94 ex af,af'95 nop96 out (pcm_data),a97 ret99 100106ramtosram: 107 ld c,pcm_data108ramtosram_lp: 109 in a,(fm1_reg)110 rra111 jr c,ramtosram_lp112 outi113 dec de114 ld a,d115 or e116 jr nz,ramtosram_lp117 ret118 119 120125set_opl4_wrt:126 ld c,2 127 ld a,10001b128 call opl4_out_wave 130 inc c131 ld a,e132 and 111111b133 call opl4_out_wave 135 inc c136 ld a,h137 call opl4_out_wave 139 inc c140 ld a,l141 call opl4_out_wave 143 ld a,6144 out (pcm_reg),a 146 ld c,pcm_data 147 ret149 150convert: 151 ld hl,sample152 ld bc,end-sample153.loop: 154 ld a,(hl)155 sub 128156 ld (hl),a157 inc hl158 dec bc159 ld a,b160 or c161 jr nz,.loop162 ret163 165sample: INCBIN "sample.raw"167end:168